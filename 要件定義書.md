  `content`: `# 要件定義書

## データ統合・出力仕様

### 基本方針
- **メインデータソース:** zp02（指図重複なし、製造指図ベース）
- **補完データソース:** zp51（サマリー化、所要日最小値ベース）
- **結合キー:** 子指図番号（zp51） = 指図番号（zp02）

### 出力フィールド仕様

| No | フィールド名 | データソース | 取得ロジック | ソート優先度 | 備考 |
|---|---|---|---|---|---|
| 1 | No | 計算 | ソート後の連番 | - | 無くてもよい |
| 2 | 親指図番号 | zp51 | 所要日の最小値レコード | - | |
| 3 | 親品目コード | zp51 | 所要日の最小値レコード | - | |
| 4 | 親品目テキスト | zp51 | 所要日の最小値レコード | - | |
| 5 | 子指図番号 | zp02 | 指図番号 | 3 | 結合キー |
| 6 | 子品目コード | zp02 | 品目コード | - | |
| 7 | 子品目テキスト | zp02 | 品目テキスト | - | |
| 8 | 所要日 | zp51 | 最小値 | 1 | 最優先ソート |
| 9 | 子指図計画開始日 | zp02 | 計画開始 | - | |
| 10 | 子指図計画終了日 | zp02 | 計画終了 | - | 代替完成日 |
| 11 | 計画数量 | zp02 | 完成残数 | - | 指図数 |
| 12 | 進捗 | zp51 | 工程(子) + C/A/C,A以外 + 検査 | - | 複合フィールド |
| 13 | 完成日 | zp02 | DLV日付 | - | 実完成日 |
| 14 | 子MRP管理者 | zp02 | MRP管理者 | 2 | 勝手に追加 |

### ソート仕様
1. **第1優先:** 所要日（昇順）
2. **第2優先:** 子MRP管理者（昇順）
3. **第3優先:** 子指図番号（昇順）

### 完成日遵守率算出仕様

#### 基準日設定
- **予定完成日:** 子指図計画終了日（zp02.計画終了）
- **実績完成日:** 完成日（zp02.DLV日付）
- **所要日:** zp51.所要日の最小値

#### 遵守率計算
```python
# 遵守判定
if 実績完成日 <= 予定完成日:
    遵守 = True
else:
    遵守 = False

# 期間別遵守率
週別遵守率 = (週内遵守件数 / 週内完成件数) * 100
月別遵守率 = (月内遵守件数 / 月内完成件数) * 100
```

### データ処理フロー

#### 1. zp51前処理（サマリー化）
```python
# 子指図番号毎にグループ化
zp51_summary = zp51.groupby('子指図番号').agg({
    '所要日': 'min',  # 最小値
    '親指図番号': 'first',  # 所要日最小レコードの値
    '親品目コード': 'first',
    '親品目テキスト': 'first',
    '工程(子)': 'first',
    'C': 'first',
    'A': 'first', 
    'C,A以外': 'first',
    '検査': 'first'
}).reset_index()
```

#### 2. データ結合
```python
# zp02をメインにleft join
merged_data = zp02.merge(
    zp51_summary, 
    left_on='指図番号', 
    right_on='子指図番号',
    how='left'
)
```

#### 3. 進捗フィールド生成
```python
def create_progress_field(row):
    progress_parts = []
    if row['工程(子)']:
        progress_parts.append(row['工程(子)'])
    if row['C'] == 'C':
        progress_parts.append('C')
    if row['A'] == 'A':
        progress_parts.append('A')
    if row['C,A以外']:
        progress_parts.append(row['C,A以外'])
    if row['検査']:
        progress_parts.append('検査')
    return ' | '.join(progress_parts)
```

### 拡張機能（将来対応）

#### 1. 材料不足識別
- **データソース:** 別途材料在庫マスタとの照合
- **判定ロジック:** BOM展開 vs 在庫数量
- **表示:** 材料不足フラグ + 不足品目リスト

#### 2. MES実績連携
- **更新頻度:** 毎時
- **データソース:** MES実績テーブル
- **連携フィールド:** 実績開始日、実績終了日、実績進捗率

#### 3. SAP手動出力対応
- **ファイル形式:** CSV/TSV両対応
- **文字エンコーディング:** UTF-8/Shift-JIS自動判定
- **インポート履歴:** 手動/自動の区別管理

### エラーハンドリング

#### データ品質チェック
1. **必須フィールド欠損チェック**
2. **日付フォーマットバリデーション**
3. **数値フィールド型チェック**
4. **結合キー重複チェック**

#### 警告・エラー出力
- データ欠損件数レポート
- 結合失敗レコードリスト
- 日付不正データ一覧

## 技術実装方針

### データベース拡張
```sql
-- 統合ビューの作成
CREATE VIEW production_summary AS
SELECT 
    ROW_NUMBER() OVER (ORDER BY zp51_min.requirement_date, zp02.mrp_manager, zp02.drawing_no) as no,
    zp51_min.parent_drawing_no,
    zp51_min.parent_item_code,
    zp51_min.parent_item_text,
    zp02.drawing_no as child_drawing_no,
    zp02.item_code as child_item_code,
    zp02.item_text as child_item_text,
    zp51_min.requirement_date,
    zp02.plan_start_date as child_plan_start_date,
    zp02.plan_end_date as child_plan_end_date,
    zp02.completion_remaining as plan_qty,
    zp51_min.progress_combined,
    zp02.dlv_date as completion_date,
    zp02.mrp_manager as child_mrp_manager
FROM mrp_management zp02
LEFT JOIN (
    SELECT 
        child_drawing_no,
        MIN(requirement_date) as requirement_date,
        FIRST_VALUE(parent_drawing_no) as parent_drawing_no,
        FIRST_VALUE(parent_item_code) as parent_item_code,
        FIRST_VALUE(parent_item_text) as parent_item_text,
        -- 進捗フィールド結合処理
        GROUP_CONCAT(process_child || '|' || c_flag || '|' || a_flag || '|' || ca_other || '|' || inspection) as progress_combined
    FROM manufacturing_orders
    WHERE requirement_date = (SELECT MIN(requirement_date) FROM manufacturing_orders mo2 WHERE mo2.child_drawing_no = manufacturing_orders.child_drawing_no)
    GROUP BY child_drawing_no
) zp51_min ON zp02.drawing_no = zp51_min.child_drawing_no
ORDER BY zp51_min.requirement_date, zp02.mrp_manager, zp02.drawing_no;