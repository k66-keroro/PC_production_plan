  `content`: `# 要件定義書 v2.0

## プロジェクト概要

### 目的
製造指図データ（zp51）とMRP管理データ（zp02）を統合し、生産計画の遵守率を可視化する管理システムを構築する。

### 背景・課題
- **現状:** Excel管理による非効率性
- **政治的状況:** 上司はExcel容認、本部長はSYUPROS推進
- **技術的課題:** 指図重複データの整理、完成日遵守率の算出困難
- **ユーザースキル:** PCスキル低、簡単操作必須

## データ仕様

### 入力データ
| ファイル | パス | 形式 | エンコーディング | サイズ | 更新頻度 |
|---------|------|------|------------------|---------|----------|
| ZP02.TXT | \\\\SAPIF01\\host\\ZP02\\ | TAB区切り | Shift-JIS | 1.5MB | 夜間バッチ |
| ZP51N.TXT | \\\\SAPIF01\\host\\ZP51N\\ | TAB区切り | Shift-JIS | 694KB | 夜間バッチ |

### データ統合方針
- **メインデータ:** zp02（指図重複なし）
- **補完データ:** zp51（所要日最小値でサマリー化）
- **結合キー:** 子指図番号（zp51） ⇔ 指図番号（zp02）

## 出力要件

### 出力フィールド仕様
| No | フィールド名 | データソース | 取得ロジック | ソート優先度 | 必須 |
|----|--------------|--------------|--------------|--------------|------|
| 1 | No | 計算 | ソート後の連番 | - | × |
| 2 | 親指図番号 | zp51 | 所要日最小値のレコード | - | ○ |
| 3 | 親品目コード | zp51 | 所要日最小値のレコード | - | ○ |
| 4 | 親品目テキスト | zp51 | 所要日最小値のレコード | - | ○ |
| 5 | 子指図番号 | zp02 | 指図番号 | 3 | ○ |
| 6 | 子品目コード | zp02 | 品目コード | - | ○ |
| 7 | 子品目テキスト | zp02 | 品目テキスト | - | ○ |
| 8 | 所要日 | zp51 | 最小値 | 1 | ○ |
| 9 | 子指図計画開始日 | zp02 | 計画開始 | - | ○ |
| 10 | 子指図計画終了日 | zp02 | 計画終了 | - | ○ |
| 11 | 計画数量 | zp02 | 完成残数 | - | ○ |
| 12 | 進捗 | zp51 | 複合（工程+C+A+検査） | - | △ |
| 13 | 完成日 | zp02 | DLV日付 | - | △ |
| 14 | 子MRP管理者 | zp02 | MRP管理者 | 2 | ○ |
| 15 | 遵守状況 | 計算 | 完成日≤計画終了日 | - | ○ |

### ソート仕様
1. **第1優先:** 所要日（昇順）
2. **第2優先:** 子MRP管理者（昇順）
3. **第3優先:** 子指図番号（昇順）

## 機能要件

### 基本機能（Phase 1）
| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F001 | データ更新 | サーバーからファイル取得・DB更新 | 高 |
| F002 | 一覧表示 | 統合データの表形式表示 | 高 |
| F003 | ソート・フィルター | 期間、管理者、ステータス絞込 | 高 |
| F004 | 遵守率計算 | 週次・月次遵守率算出・表示 | 高 |
| F005 | Excel出力 | 表示データのExcel出力 | 中 |

### 拡張機能（Phase 2）
| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F006 | 材料不足識別 | BOM展開による材料不足検出 | 低 |
| F007 | MES実績連携 | 毎時更新されるMES実績取込 | 低 |
| F008 | SAP手動出力対応 | 手動出力ファイルの取込対応 | 低 |
| F009 | ガントチャート | 工程進捗の視覚化 | 低 |
| F010 | アラート機能 | 遅延・問題の自動通知 | 低 |

## 遵守率計算仕様

### 判定ロジック
```python
# 遵守判定
def is_compliant(completion_date, plan_end_date):
    \"\"\"
    Args:
        completion_date: 完成日（zp02.DLV日付）
        plan_end_date: 計画終了日（zp02.計画終了）
    Returns:
        bool: 遵守=True, 未遵守=False
    \"\"\"
    if completion_date is None:
        return None  # 未完成（判定対象外）
    return completion_date <= plan_end_date
```

### 期間別集計
- **週次遵守率:** 毎週月曜日起算
- **月次遵守率:** 毎月1日起算
- **集計対象:** DLV日付がNOT NULLのレコードのみ

### 表示形式
```
今週の遵守率: 75.0% (12件/16件完成)
今月の遵守率: 82.4% (42件/51件完成)
```

## 非機能要件

### パフォーマンス要件
- **データ更新時間:** 2MB以内のファイルを30秒以内で処理
- **画面表示時間:** 100件表示を3秒以内
- **メモリ使用量:** 512MB以内

### ユーザビリティ要件
- **操作習得時間:** 30分以内（PCスキル低想定）
- **エラー表示:** 日本語、原因・対処法明示
- **画面遷移:** 最大3クリック以内でタスク完了

### 可用性要件
- **稼働時間:** 平日8:00-18:00（業務時間内）
- **障害回復時間:** 手動復旧5分以内
- **データ保全:** ローカルバックアップ機能

## データ品質要件

### 入力データ検証
| 項目 | 検証内容 | エラー処理 |
|------|----------|------------|
| 必須フィールド | NULL値チェック | 警告表示、処理続行 |
| 日付形式 | YYYY/MM/DD形式 | 自動変換、失敗時エラー |
| 数値形式 | 数値型変換可能 | 0で補完、警告表示 |
| 文字エンコーディング | Shift-JIS読込可能 | 自動変換、失敗時中断 |

### データ整合性チェック
- **結合整合性:** zp02に存在しないzp51データの警告
- **日付整合性:** 開始日≤終了日の検証
- **数値整合性:** 負数値の警告

## セキュリティ要件

### データアクセス制御
- **ファイルアクセス:** 読み込み専用
- **ネットワークアクセス:** 指定サーバーのみ
- **データ保存:** ローカルPC内のみ

### プライバシー保護
- **個人情報:** MRP管理者名のマスキング（オプション）
- **機密情報:** ログファイルの暗号化

## 運用要件

### 更新運用
- **定期更新:** 手動実行（朝一番推奨）
- **臨時更新:** 必要に応じて随時実行
- **更新確認:** 最終更新日時の表示

### エラー対応
- **ログ出力:** エラー内容の詳細記録
- **復旧手順:** エラー別対処法の文書化
- **エスカレーション:** 解決不可時の連絡先明示

## 制約事項

### 技術制約
- **開発環境:** Python 3.8以上、Streamlit
- **実行環境:** Windows 10/11、ネットワークドライブアクセス可
- **データベース:** SQLite（軽量・保守不要）

### 業務制約
- **サーバーアクセス:** 社内ネットワーク内のみ
- **ファイル形式:** TAB区切りテキスト（変更不可）
- **文字エンコーディング:** Shift-JIS（SAP出力形式）

### 将来制約
- **SYUPROS統合:** 2026年度予定、API連携準備必要
- **スケーラビリティ:** データ量10倍増加対応
- **マルチユーザー:** 複数同時アクセス対応準備