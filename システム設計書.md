`content`: `# システム設計書

## アーキテクチャ概要

### システム構成
```
[サーバー] \\\\SAPIF01\\host\\
    ├── ZP02\\ZP02.TXT     # MRP管理データ（メイン）
    └── ZP51N\\ZP51N.TXT   # 製造指図データ（補完）
         ↓ 自動取得
[ローカルPC] C:\\Users\\sem3171\\PC_production_plan\\
    ├── app.py           # Streamlitメインアプリ
    ├── data\\            # ローカルキャッシュ
    │   ├── production.db    # SQLiteデータベース
    │   ├── ZP02.TXT        # キャッシュファイル
    │   └── ZP51N.TXT       # キャッシュファイル
    └── src\\             # ソースコード
         ↓ Web UI
[ブラウザ] http://localhost:8501
```

## データフロー設計

### 1. データ取得・更新フロー
```python
サーバーファイル取得 → エンコーディング変換 → SQLite格納 → 統合処理 → UI表示
```

### 2. データ統合ロジック
```sql
-- Step1: zp51サマリー作成（所要日最小値ベース）
CREATE TEMP VIEW zp51_summary AS
SELECT 
    child_drawing_no,
    MIN(requirement_date) as min_requirement_date,
    parent_drawing_no,
    parent_item_code, 
    parent_item_text,
    progress_combined
FROM manufacturing_orders mo1
WHERE requirement_date = (
    SELECT MIN(requirement_date) 
    FROM manufacturing_orders mo2 
    WHERE mo2.child_drawing_no = mo1.child_drawing_no
)
GROUP BY child_drawing_no;

-- Step2: メインデータ統合
CREATE VIEW production_summary AS
SELECT 
    ROW_NUMBER() OVER (
        ORDER BY z51.min_requirement_date, z02.mrp_manager, z02.drawing_no
    ) as no,
    z51.parent_drawing_no,
    z51.parent_item_code,
    z51.parent_item_text,
    z02.drawing_no as child_drawing_no,
    z02.item_code as child_item_code,
    z02.item_text as child_item_text,
    z51.min_requirement_date as requirement_date,
    z02.plan_start_date as child_plan_start_date,
    z02.plan_end_date as child_plan_end_date,
    z02.completion_remaining as plan_qty,
    z51.progress_combined as progress,
    z02.dlv_date as completion_date,
    z02.mrp_manager as child_mrp_manager,
    -- 遵守判定
    CASE 
        WHEN z02.dlv_date IS NOT NULL AND z02.dlv_date <= z02.plan_end_date 
        THEN 1 ELSE 0 
    END as compliance_flag
FROM mrp_management z02
LEFT JOIN zp51_summary z51 ON z02.drawing_no = z51.child_drawing_no
ORDER BY z51.min_requirement_date, z02.mrp_manager, z02.drawing_no;
```

## UIコンポーネント設計

### メイン画面構成
```
┌─────────────────────────────────────────────────────────┐
│ 🏭 生産計画管理システム                                     │
├─────────────────────────────────────────────────────────┤
│ [📊 データ更新] [📈 遵守率表示] [📋 Excel出力]                │
├─────────────────────────────────────────────────────────┤
│ 📋 フィルター                                            │
│ 期間: [2025/09/01] ～ [2025/12/31]                      │
│ MRP管理者: [全て▼] ステータス: [全て▼]                    │
├─────────────────────────────────────────────────────────┤
│ 📊 生産計画一覧                                          │
│ No│親指図  │所要日    │子指図    │品目      │計画終了  │完成日│遵守│
│ 1 │I-0326..│2025/03/04│26062001..│SRG40TG..│2025/10/28│      │ ❌ │
│ 2 │I-0326..│2025/03/04│26062001..│SRG40TG..│2025/10/28│      │ ❌ │
├─────────────────────────────────────────────────────────┤
│ 📈 遵守率サマリー                                         │
│ 今週: 75% (12/16件) 今月: 82% (41/50件)                  │
└─────────────────────────────────────────────────────────┘
```

## ファイル構成設計

### ソースコード構成
```
src/
├── __init__.py
├── database/
│   ├── __init__.py
│   ├── connection.py      # SQLite接続管理
│   ├── models.py         # テーブル定義
│   └── queries.py        # SQLクエリ集
├── importers/
│   ├── __init__.py
│   ├── file_handler.py   # ファイル取得・変換
│   └── data_importer.py  # データインポート処理
├── processors/
│   ├── __init__.py
│   ├── data_merger.py    # データ統合処理
│   └── compliance_calc.py # 遵守率計算
├── ui/
│   ├── __init__.py
│   ├── components.py     # UI部品
│   ├── filters.py        # フィルター機能
│   └── charts.py         # グラフ表示
└── utils/
    ├── __init__.py
    ├── config.py         # 設定管理
    ├── logger.py         # ログ機能
    └── helpers.py        # ヘルパー関数
```

## エラーハンドリング設計

### ユーザーフレンドリーエラー表示
```python
エラー種別 → 表示メッセージ → 対処法表示

ネットワークエラー → \"サーバーに接続できません\" → \"ネットワーク管理者に連絡してください\"
ファイル不存在   → \"データファイルが見つかりません\" → \"ファイルパスを確認してください\"
データ形式エラー → \"ファイル形式が正しくありません\" → \"最新のファイルを取得してください\"
```

## パフォーマンス設計

### データ処理最適化
- **インクリメンタル更新:** 差分のみ処理
- **インデックス活用:** 頻繁に使用するカラムにINDEX
- **メモリ効率:** pandasのchunk処理で大容量対応
- **キャッシュ機能:** 処理結果の一時保存

### UI応答性
- **プログレスバー:** 長時間処理の進捗表示
- **非同期処理:** バックグラウンドでデータ更新
- **ページング:** 大量データの分割表示

## セキュリティ設計

### データ保護
- **ローカル保存:** 機密データはローカルのみ
- **アクセス制限:** 必要最小限のファイルアクセス
- **ログ管理:** 操作履歴の記録

## 設定管理

### config.py
```python
# ファイルパス設定
SERVER_PATHS = {
    'ZP02': r'\\\\SAPIF01\\host\\ZP02\\ZP02.TXT',
    'ZP51N': r'\\\\SAPIF01\\host\\ZP51N\\ZP51N.TXT'
}

# データベース設定
DATABASE_PATH = 'data/production.db'

# UI設定
UI_CONFIG = {
    'title': '🏭 生産計画管理システム',
    'page_size': 100,
    'date_format': 'YYYY/MM/DD'
}

# エンコーディング設定
ENCODING = {
    'input': 'shift-jis',
    'output': 'utf-8'
}
```

## 拡張性設計

### プラグイン構造
- **インポーター追加:** 新しいデータソース対応
- **プロセッサー追加:** 新しい計算ロジック追加
- **エクスポーター追加:** 新しい出力形式対応

### SYUPROS連携準備
- **APIインターフェース:** REST API対応準備
- **データ形式標準化:** JSON/XML対応
- **認証機能:** SYUPROS認証連携準備
`